# C++可定制化无障碍输入系统与配置工具

这是一个基于C++开发的PC端高效辅助输入解决方案，旨在为有特殊操作需求的用户提供一个高度灵活、可定制的控制体验。项目硬件核心为ESP32-S3，软件部分完全使用C++实现，将设备模拟为标准的USB HID键盘，实现了跨平台的即插即用。

---

## 核心功能

* **高度灵活的按键映射 (Key Mapping)**：支持将1个模拟摇杆和10个物理按键自由映射为任意标准键盘按键。
* **多配置文件 (Multi-Profile)**：内置5套独立的映射配置文件，用户可通过专用物理按键进行快速循环切换，以适应不同的应用或游戏场景。
* **实时状态反馈**：通过板载LED的不同闪烁次数，清晰地向用户反馈当前所处的配置文件编号。
* **动态命令行配置 (CLI)**：无需重新编程固件，通过串口连接即可进入配置模式，使用文本命令动态修改、查询、保存所有按键映射。
* **数据持久化**：所有用户的自定义配置均保存在ESP32的非易失性存储(NVS)中，确保设备断电后设置不丢失。
* **高精度输入处理**：内置了软件防抖(Debouncing)、摇杆死区(Deadzone)及迟滞处理算法，有效过滤信号噪声，防止误触和卡键，保证操作的精确性。

## 技术架构与实现

本项目采用**C++面向对象**的思想进行设计，核心架构基于**有限状态机 (FSM)**，清晰地划分了两个核心模式：

1.  **标准工作模式 (`runNormalMode`)**：设备作为USB键盘进行工作。在此模式下，程序以低延迟实时轮询所有输入，经过算法处理后，将结果转换为HID键盘报告发送给主机。
2.  **参数配置模式 (`runConfigMode`)**：设备通过串口与用户进行交互。在此模式下，程序会启动一个**基于字符串解析和分派的命令处理器**，响应用户的配置指令。

### 关键技术点
* **硬件抽象层 (HAL)**：通过软件将物理IO引脚（GPIO, ADC）封装为逻辑对象（如`joystick`, `button`），使上层应用逻辑与底层硬件解耦。
* **实时信号处理算法**：
    * **防抖**：采用基于`millis()`的时间滞后滤波算法，确保只在按键状态稳定后才触发逻辑。
    * **死区/迟滞**：为模拟摇杆设置中心死区，并引入迟滞比较，避免在阈值边缘的物理抖动导致按键的“粘滞”或“连击”。
* **数据持久化**：利用ESP32的`Preferences`库，设计了一套键值对(Key-Value)存储方案，将复杂的Profile配置数据高效地序列化并读写于NVS分区。
* **命令行接口 (CLI)**：实现了一个可扩展的命令解析器，能够处理不同格式的命令和参数，并提供清晰的反馈信息和错误提示。

## 如何使用

### 1. 标准工作模式

1.  将设备通过USB线连接到电脑，系统会自动将其识别为标准键盘，无需安装任何驱动。
2.  默认加载上一次使用的配置文件。
3.  按下设备上的**“Profile切换键”**，即可在5套配置之间循环切换（1 -> 2 -> 3 -> 4 -> 5 -> 1）。切换成功后，设备上的LED会闪烁相应的次数来提示当前配置编号。

### 2. 参数配置模式

当需要自定义按键映射时，请按以下步骤操作：

1.  **进入配置模式**：在设备**未通电**的情况下，**按住“Profile切换键”不放**，然后将设备通过USB连接到电脑。此时设备将进入配置模式，LED会以特定的频率闪烁（例如慢闪）作为提示。
2.  **打开串口监视器**：使用Arduino IDE的串口监视器或其他串口工具，设置波特率为 `115200`，并连接到设备对应的COM端口。
3.  **使用配置命令**：在串口监视器的输入框中输入命令并发送。命令不区分大小写。

#### 主要配置命令示例：

* **显示帮助信息**
    ```
    help
    ```

* **显示指定配置文件的当前映射** (例如显示Profile 2的配置)
    ```
    show 2
    ```

* **设置按键映射** (核心命令)
    * **格式**: `P<Profile编号> <目标> <按键>`
    * **示例1**: 将 **Profile 1** 的 **按钮3 (B3)** 映射为 **左Shift键 (LSHIFT)**
        ```
        P1 B3 LSHIFT
        ```
    * **示例2**: 将 **Profile 2** 的 **摇杆按下键 (JOY)** 映射为 **空格键 (SPACE)**
        ```
        P2 JOY SPACE
        ```
    * **示例3**: 将 **Profile 5** 的 **按钮1 (B1)** 映射为 **小写字母'g'**
        ```
        P5 B1 g
        ```

* **保存当前所有配置**
    > **注意**：所有使用`P...`命令的设置都只在内存中生效，必须使用`save`命令才能将其永久写入闪存。
    ```
    save
    ```

* **重置所有配置为默认值**
    > **注意**：此操作会清除内存中的所有自定义映射，恢复为代码中的默认设置。同样需要`save`命令来使其永久生效。
    ```
    reset
    ```
* **退出配置模式**
    ```
    exit
    ```
    > 输入此命令后，设备将自动重启并进入标准工作模式。

## 开发环境

* **硬件平台**: ESP32-S3-N16R8
* **开发框架**: Arduino Core for ESP32
* **编程语言**: C++
* **主要依赖库**: `USB.h` (USBHIDKeyboard), `Preferences.h`